<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="stylesheet" href="./leaflet.css" />
  <link rel="stylesheet" href="./styles.css" />
  <title>VakarosLive</title>
</head>

<body>
  <header class="header">
    <div class="title">VakarosLive <span id="appVersion" class="title__version">-</span></div>
    <div class="header__right">
      <div class="header__ble">
        <button id="bleConnect" class="btn btn--sm">Conectar BLE</button>
        <button id="bleDisconnect" class="btn btn--ghost btn--sm" disabled>Desconectar</button>
        <button id="recToggle" class="btn btn--ghost btn--sm" type="button"
          title="Grabar sesión (raw + parseado)">Grabar</button>
        <button id="recDownload" class="btn btn--ghost btn--sm" type="button" disabled>Descargar</button>
        <div class="header__settings">
          <label class="toggle" title="Mantiene la pantalla encendida (Wake Lock)">
            <input type="checkbox" id="bleWakeLock" checked />
            <span class="toggle__label">Pantalla ON</span>
          </label>
          <label class="toggle" title="Evita que el móvil congele la app al apagar la pantalla (Audio persistence)">
            <input type="checkbox" id="bleBackground" checked />
            <span class="toggle__label">2º Plano</span>
          </label>
        </div>
        <span class="muted" id="bleInfo">-</span>
      </div>
      <div id="status" class="status status--disconnected">Desconectado</div>
    </div>
  </header>

  <main class="grid">
    <section class="card card--wide" data-card="nav">
      <div class="card__title">
        <span>Navegación</span>
        <button class="map-btn card-toggle" type="button" data-card-toggle aria-label="Minimizar">▾</button>
      </div>
      <div class="nav2">
        <div class="nav2__block">
          <div class="muted">HDG (mag)</div>
          <div class="nav2__hdg">
            <div class="big" id="navHdg">-</div>
            <div class="nav2__cog">COG <span id="navCogInline">-</span></div>
          </div>
        </div>
        <div class="nav2__block">
          <div class="muted">SOG</div>
          <div class="big" id="navSog">-</div>
        </div>
      </div>
      <div class="metrics metrics--4">
        <div class="kv"><span class="k">COG</span><span class="v" id="navCog">-</span></div>
        <div class="kv"><span class="k">Δ (COG-HDG)</span><span class="v" id="navDelta">-</span></div>
        <div class="kv"><span class="k">Fuente</span><span class="v" id="navSrc">-</span></div>
        <div class="kv"><span class="k">Última</span><span class="v" id="navLast">-</span></div>
      </div>
    </section>

    <section class="card" data-card="mark">
      <div class="card__title">
        <span>Marca</span>
        <button class="map-btn card-toggle" type="button" data-card-toggle aria-label="Minimizar">▾</button>
      </div>
      <div class="row">
        <button id="setMark" class="btn">Guardar marca</button>
        <button id="clearMark" class="btn btn--ghost">Borrar</button>
      </div>
      <div class="kv"><span class="k">Dist</span><span class="v" id="markDist">-</span></div>
      <div class="kv"><span class="k">BRG</span><span class="v" id="markBrg">-</span></div>
    </section>

    <section class="card card--wide" data-card="attitude">
      <div class="card__title">
        <span>Actitud (Atlas)</span>
        <button class="map-btn card-toggle" type="button" data-card-toggle aria-label="Minimizar">▾</button>
      </div>
      <div class="metrics metrics--4">
        <div class="kv"><span class="k">Heel</span><span class="v" id="heel">-</span></div>
        <div class="kv"><span class="k">Pitch</span><span class="v" id="pitch">-</span></div>
        <div class="kv"><span class="k">SOG (m/s)</span><span class="v" id="field6">-</span></div>
        <div class="kv"><span class="k">COG test</span><span class="v" id="cogTest">-</span></div>
        <div class="kv"><span class="k">Compact 2</span><span class="v" id="compact2">-</span></div>
      </div>
      <div class="muted" id="bleDebug">BLE: -</div>
      <div class="muted">Nota: campos por confirmar; se muestran tal cual.</div>
    </section>

    <section class="card card--wide" data-card="race">
      <div class="card__title">
        <span>Balizas / Rendimiento</span>
        <div style="margin-left:auto; display:flex; gap:4px">
          <button id="perfFullscreen" class="map-btn">Full</button>
          <button class="map-btn card-toggle" type="button" data-card-toggle aria-label="Minimizar">▾</button>
        </div>
      </div>
      <div class="row">
        <span class="muted">Tipo</span>
        <select id="courseType" class="select" style="width:auto">
          <option value="W/L">Barlovento/Sotavento</option>
          <option value="Triangle">Triángulo</option>
          <option value="Trapezoid">Trapecio</option>
        </select>
      </div>
      <div class="row">
        <button id="setWindward" class="btn">Set barlovento</button>
        <button id="setLeewardPort" class="btn">Set sotavento P</button>
        <button id="setLeewardStarboard" class="btn">Set sotavento S</button>
        <button id="setWing" class="btn">Set wing</button>
        <button id="setReach" class="btn">Set reach</button>
        <button id="clearRaceMarks" class="btn btn--ghost">Borrar balizas</button>
      </div>
      <div class="row">
        <span class="muted">Objetivo</span>
        <select id="targetSelect" class="select">
          <option value="">-</option>
          <option value="mark">Marca</option>
          <option value="windward">Barlovento</option>
          <option value="leeward_gate">Sotavento (puerta)</option>
          <option value="leeward_port">Sotavento P</option>
          <option value="leeward_starboard">Sotavento S</option>
          <option value="wing">Wing (Gybe)</option>
          <option value="reach">Reach</option>
        </select>
        <span class="muted" id="targetHint">-</span>
      </div>
      <div class="metrics">
        <div class="kv"><span class="k">Dist</span><span class="v" id="targetDist">-</span></div>
        <div class="kv"><span class="k">BRG</span><span class="v" id="targetBrg">-</span></div>
        <div class="kv"><span class="k">CMG</span><span class="v" id="targetCmg">-</span></div>
        <div class="kv"><span class="k">ETA</span><span class="v" id="targetEta">-</span></div>
        <div class="kv"><span class="k">ETA Layline</span><span class="v" id="targetLaylineEta">-</span></div>
      </div>
      <div class="chart">
        <canvas id="perfChart" class="chart__canvas"></canvas>
        <div id="perfLegend" class="chart__legend muted">
          <span class="legend legend--sog">SOG</span>
          <span class="legend legend--cmg">CMG</span>
          <span class="legend legend--hdg">HDG</span>
        </div>
      </div>
    </section>

    <section class="card card--wide" data-card="start">
      <div class="card__title">
        <span>Salida (línea)</span>
        <button class="map-btn card-toggle" type="button" data-card-toggle aria-label="Minimizar">▾</button>
      </div>
      <div class="row">
        <button id="setPin" class="btn">Set PIN</button>
        <button id="setRcb" class="btn">Set RCB</button>
        <button id="clearStartLine" class="btn btn--ghost">Borrar línea</button>
        <button id="toggleStartAuto" class="btn btn--ghost">Auto Atlas2</button>
        <span class="muted" id="startSource">-</span>
      </div>
      <div class="metrics">
        <div class="kv"><span class="k">PIN dist</span><span class="v" id="pinDist">-</span></div>
        <div class="kv"><span class="k">PIN brg</span><span class="v" id="pinBrg">-</span></div>
        <div class="kv"><span class="k">RCB dist</span><span class="v" id="rcbDist">-</span></div>
        <div class="kv"><span class="k">RCB brg</span><span class="v" id="rcbBrg">-</span></div>
        <div class="kv"><span class="k">Línea</span><span class="v" id="lineBrg">-</span></div>
        <div class="kv"><span class="k">Largo</span><span class="v" id="lineLen">-</span></div>
        <div class="kv"><span class="k">Dist a línea</span><span class="v" id="distLine">-</span></div>
        <div class="kv"><span class="k">ETA línea</span><span class="v" id="etaLine">-</span></div>
      </div>
    </section>

    <section class="card card--wide" data-card="map">
      <div class="card__title">
        <span>Mapa</span>
        <div class="map-controls">
          <button id="mapTypeStreet" class="map-btn map-btn--active">Calles</button>
          <button id="mapTypeSat" class="map-btn">Satélite</button>
          <button id="mapTypeNautical" class="map-btn">Náutico</button>
          <button id="mapCenter" class="map-btn">Centrar</button>
          <button id="mapFullscreen" class="map-btn" aria-label="Mapa a pantalla completa">Full</button>
          <button class="map-btn card-toggle" type="button" data-card-toggle aria-label="Minimizar">▾</button>
        </div>
      </div>
      <div id="map" class="map"></div>
      <div class="muted" id="lastUpdate">-</div>
    </section>

    <section class="card" data-card="experts">
      <div class="card__title">
        <span>Expert parameters</span>
        <button class="map-btn card-toggle" type="button" data-card-toggle aria-label="Minimizar">▾</button>
      </div>
      <div class="muted">Estilo B&amp;G: damping por dato. OFF = raw (sin suavizado).</div>

      <div class="expert-row">
        <div class="expert-label">
          <div class="expert-title">Heading (HDG)</div>
          <div class="muted">Rumbo magnético mostrado en la UI.</div>
        </div>
        <div class="expert-control">
          <input id="dampingHeading" type="range" min="0" max="20" step="1" value="10" />
          <div class="muted mono" id="dampingHeadingValue">10</div>
        </div>
      </div>

      <div class="expert-row">
        <div class="expert-label">
          <div class="expert-title">COG</div>
          <div class="muted">Course Over Ground.</div>
        </div>
        <div class="expert-control">
          <input id="dampingCog" type="range" min="0" max="20" step="1" value="10" />
          <div class="muted mono" id="dampingCogValue">10</div>
        </div>
      </div>

      <div class="expert-row">
        <div class="expert-label">
          <div class="expert-title">SOG</div>
          <div class="muted">Speed Over Ground.</div>
        </div>
        <div class="expert-control">
          <input id="dampingSog" type="range" min="0" max="20" step="1" value="10" />
          <div class="muted mono" id="dampingSogValue">10</div>
        </div>
      </div>

      <div class="expert-row">
        <div class="expert-label">
          <div class="expert-title">Heel</div>
          <div class="muted">Escora.</div>
        </div>
        <div class="expert-control">
          <input id="dampingHeel" type="range" min="0" max="20" step="1" value="9" />
          <div class="muted mono" id="dampingHeelValue">9</div>
        </div>
      </div>

      <div class="expert-row">
        <div class="expert-label">
          <div class="expert-title">Pitch</div>
          <div class="muted">Cabeceo.</div>
        </div>
        <div class="expert-control">
          <input id="dampingPitch" type="range" min="0" max="20" step="1" value="9" />
          <div class="muted mono" id="dampingPitchValue">9</div>
        </div>
      </div>

      <div class="expert-row">
        <div class="expert-label">
          <div class="expert-title">Posición</div>
          <div class="muted">Lat/Lon (distancias/ETA). El track del mapa usa GPS crudo.</div>
        </div>
        <div class="expert-control">
          <input id="dampingPosition" type="range" min="0" max="20" step="1" value="8" />
          <div class="muted mono" id="dampingPositionValue">8</div>
        </div>
      </div>

      <div class="muted">Más damping = más estabilidad, menos damping = más respuesta.</div>
    </section>
  </main>

  <script src="./leaflet.js"></script>
  <script src="./app.js"></script>
</body>

</html>